# 更新日志 (CHANGELOG)

## [今日更新] - 2025年1月15日

### 🚀 核心系统优化

#### 角色出生系统全面升级 (2025-09-08)
- **多职业配置支持** - 完善战士、法师、道士三大职业的个性化出生配置
- **性别差异化设置** - 支持按职业和性别组合提供不同的初始装备和道具
- **全装备部位覆盖** - 支持16个装备部位的完整初始装备配置系统
- **智能道具分发** - 实现最多10个道具的灵活初始分发机制
- **多货币系统集成** - 支持金币、银币、元宝的精确初始分配
- **技能预设功能** - 新增2个初始技能的自动配置能力
- **绑定状态管理** - 完善装备和道具的绑定状态精确控制

#### 行会建筑系统重构  (2025-09-08)
- **建筑等级体系** - 实现完整的建筑升级和等级限制管理系统
- **多资源消耗机制** - 集成行会资金、粮食、木材、石料、铁料等资源管理
- **建筑数量控制** - 新增每种建筑类型的最大数量限制功能
- **前置条件系统** - 建立建筑间的依赖关系和前置条件验证
- **守卫集成优化** - 完善建筑与基座守卫、守卫模板的关联机制
- **升级时间管理** - 实现建筑升级的精确时间控制系统
- **日常维护机制** - 新增建筑日常消费和维护成本计算
- **效果参数扩展** - 支持5个自定义参数和效果的灵活配置

#### 技术架构改进
- **CSV解析增强** - 实现智能分隔符检测，支持制表符和逗号自动识别
- **多编码兼容** - 通过编码检测工具完美处理中文文件和路径
- **容错机制完善** - 添加详细错误日志和异常处理，提升系统稳定性
- **动态字段映射** - 支持灵活的列索引解析和字段动态映射
- **高效数据加载** - 使用CsvHelper库优化CSV数据解析性能

---

### 🔄 系统集成优化

#### 玩家成长链条完善
- **新手引导强化** - 出生物品系统为新玩家提供完整的基础装备和资源保障
- **中后期发展支持** - 行会建筑系统为玩家提供团队合作和资源管理的高级玩法
- **资源循环优化** - 两个系统协同工作，形成完整的游戏内货币和道具流转机制
- **数据一致性保证** - 确保角色创建和行会发展的数据完整性和一致性

---

### 📊 本次更新统计
- **核心系统数**: 2个重要系统全面优化
- **支持职业数**: 3个职业完整配置支持
- **装备部位数**: 16个装备部位全覆盖
- **道具配置数**: 最多10个道具灵活配置
- **建筑参数数**: 5个自定义参数支持
- **资源类型数**: 5种建筑资源完整管理
- **技术改进**: CSV解析、编码支持、容错机制全面提升

---

## [0825 分支] - 2025年9月8日

### 🔧 系统优化

#### 全服公告系统简化 (2025-09-08)
- **简化公告配置** - 将复杂的物品获得公告模板简化为单一欢迎消息
- **优化公告格式** - 修改全服公告.csv文件结构，从多条复杂公告简化为简洁的欢迎信息
- **提升系统性能** - 减少公告系统的复杂度，提升服务器性能
- **改进用户体验** - 使用更简洁友好的欢迎消息替代重复的物品获得提示

#### 技术细节
- **文件修改** - 更新 `Database/System/全服公告.csv` 配置文件
- **字段调整** - 将字段名从 `Id,Key` 改为 `编号,内容`
- **内容精简** - 移除5条重复的物品获得公告，保留1条简洁的欢迎消息
- **提交哈希** - cb21904cf9c40ad0bc52f291fe3951024686dc46

---

### 📊 本次优化统计
- **修改文件数**: 1个配置文件
- **简化公告条数**: 从5条减少到1条
- **影响系统**: 全服公告广播系统
- **性能提升**: 减少公告处理复杂度

---

## [0722_fix 分支] - 2025年7月26日

### 🐛 Bug修复

#### NPC脚本系统修复 (2025-07-26)
- **修复NPC脚本文件缺失问题** - 解决 "Script Not Found: 6412-月灵香31" 错误
- **创建缺失脚本文件** - 在 `Database\System\Envir\NPCs\` 目录下创建 `6412-月灵香31.txt` 脚本文件
- **商店功能恢复** - NPC "月灵香31" 现在可以正常点击使用，商店可以正常打开
- **脚本格式标准化** - 使用标准的 NPC 脚本格式：`[@MAIN]` 主入口和 `<#Dft>` 默认商店UI

#### 技术细节
- **问题根因分析** - 发现 `守卫实例.cs:770` 中使用 `$"{模板编号}-{对象模板.守卫名字}"` 格式查找脚本文件
- **文件路径机制** - 确认 NPC 脚本文件应放置在 `Settings.NPCPath` 指定的目录中
- **编码问题处理** - 解决压缩包解压时的中文文件名编码问题
- **脚本加载逻辑** - 验证了 `NPCScript.GetOrAdd` 和 `LoadInfo` 方法的脚本加载机制

---

### 📊 本次修复统计
- **修复Bug数**: 1个关键NPC交互问题
- **创建文件**: 1个NPC脚本文件
- **影响NPC**: ID 6412 "月灵香31" 商店NPC
- **测试验证**: 通过日志分析和脚本系统验证

---

## [历史版本]

服务器关闭流程优化 (2025-07-20)
一键安全关闭 - 现在点击右上角关闭按钮时，如果服务器正在运行，会弹出提示“游戏服务器正在运行，是否停止游戏服务器并保存数据后关闭程序？”，用户可选择“是”自动停止服务器并保存数据后关闭程序，选择“否”则取消关闭。
自动保存与进度提示 - 自动等待服务器完全停止并保存所有数据，系统日志实时显示进度，确保数据安全。
用户体验提升 - 关闭流程无需手动多步操作，防止误操作导致数据丢失，提升了易用性和安全性。
适配新版主窗口 - 修复了原有只在旧窗口生效的问题，现已兼容新版 DevExpress 主窗口（SMain.cs）。

## [0629 分支] - 2025年7月9日 至 2025年7月20日

### 🚀 重大新功能

#### 主题系统重构 (2025-07-20)
- **重构主题系统架构** - 将主题礼包和商品模板迁移至新目录结构
- **新增主题系统开关配置** - 支持动态开启/关闭主题功能
- **优化文件编码支持** - 支持GB18030编码的CSV文件读取
- **创建专用主题类** - 新增 `玩家实例_主题.cs` 部分类实现

#### 假人系统全面升级 (2025-07-09 ~ 2025-07-20)
- **完整假人控制系统** - 新增假人控制服务器和管理界面
- **职业选择功能** - 支持战士、法师、道士职业选择
- **批量管理功能** - 支持批量创建、状态设置和离线管理
- **智能AI配置** - 强制使用新版挂机系统，优化AI行为
- **自动补货系统** - 实现假人摆摊自动补货功能
- **日志系统集成** - 添加多级别日志记录支持

### 🔄 系统重构

#### 任务系统架构重构 (2025-07-20)
- **文件结构优化** - 重命名任务相关类为中文名称提升可读性
- **模板类重构** - 迁移旧代码到新结构，提升可维护性
- **枚举类整理** - 重构任务相关枚举类，清理冗余数据
- **大规模清理** - 删除大量过时或重复的任务文件 (200+ 个成就文件)

#### 守卫系统优化 (2025-07-14 ~ 2025-07-20)
- **实例类重构** - 合并新旧构造函数，优化属性和方法
- **行为逻辑增强** - 优化移动、战斗和聊天逻辑
- **性能优化** - 减少不必要的日志输出和体力值设置
- **模板系统升级** - 支持更复杂的守卫行为和移动路径配置

### 🛠️ 功能优化

#### 摆摊系统改进
- **逻辑简化** - 移除摆摊编号和模板相关功能
- **状态管理优化** - 简化摆摊状态管理逻辑
- **服务器端处理** - 确保摆摊数据完全依赖服务器端处理

#### 玩家系统增强
- **部分类重构** - 调整玩家实例类为部分类结构
- **功能模块化** - 分离主题、摆摊等功能到独立文件
- **代码精简** - 删除冗余的摆摊相关方法和属性

### 🗂️ 项目结构优化

#### 文件组织改进
- **删除备份文件** - 清理大量 `.backup`、`.new`、`.csnew` 等备份文件
- **目录结构调整** - 重新组织模板类和数据文件目录
- **文档整理** - 删除过时的文档和注释，提升代码整洁性

#### 数据文件迁移
- **活动数据重组** - 将传永七天活动数据移动到活动数据目录
- **主题数据集中** - 统一管理主题商品和物品数据
- **配置文件优化** - 更新 Setup.ini 和项目配置

### 🐛 Bug修复

#### 编码问题修复
- **CSV文件编码** - 修复守卫数据加载时的编码问题
- **文件读取优化** - 改进中文文件名和路径处理

#### 功能稳定性提升
- **NPC对话系统** - 调整NPC说话功能的触发条件
- **数据一致性** - 修复假人批量创建时的数据一致性问题
- **内存管理** - 优化对象创建和销毁逻辑

### 🔧 开发工具改进

#### 构建系统增强 (2025-07-20)
- **PowerShell构建脚本** - 新增 `build-gameserver.ps1` 完整构建流程
- **打包工具** - 新增 `build-package.ps1` 支持多种部署方式
- **跨平台支持** - 新增 `build-gameserver.sh` Linux/WSL版本
- **自动化验证** - 集成构建输出验证和错误检测

#### 项目配置更新
- **csproj优化** - 更新GameServer项目配置
- **依赖管理** - 优化NuGet包引用和路径设置

### 📊 统计数据

#### 代码变更统计
- **删除文件**: 200+ 个过时的成就任务文件
- **重构类**: 10+ 个核心系统类重构
- **新增功能**: 假人控制系统、主题系统、构建工具
- **代码清理**: 删除数千行冗余代码和注释

#### 系统影响范围
- **假人系统**: 全面重写，新增控制界面
- **主题系统**: 架构重构，模块化设计
- **任务系统**: 文件结构优化，提升可维护性
- **守卫系统**: 性能优化，功能增强
- **构建系统**: 从无到有，完整自动化流程

### 🎯 技术亮点

#### 架构改进
- **模块化设计** - 采用部分类拆分大型类文件
- **配置驱动** - 新增多个开关配置支持功能启停
- **国际化支持** - 优化中文编码处理和文件名支持

#### 性能优化
- **日志减少** - 减少不必要的调试日志输出
- **内存优化** - 优化对象生命周期管理
- **批量处理** - 支持假人批量操作提升效率

#### 开发体验
- **智能构建** - 自动依赖检查和错误诊断
- **可视化管理** - 假人控制器提供图形化管理界面
- **文档完善** - 构建脚本包含详细使用说明

### 🔮 后续规划

#### 短期目标
- [ ] 完善假人AI行为逻辑
- [ ] 优化主题系统性能
- [ ] 增强构建系统功能

#### 中期目标
- [ ] 任务系统UI界面开发
- [ ] 守卫系统可视化编辑器
- [ ] 完整的部署自动化流程

---

### 📝 提交统计

**时间范围**: 2025-07-09 至 2025-07-20 (12天)  
**总提交数**: 28 个提交  
**主要贡献者**: 黑泽明  
**影响文件数**: 100+ 个文件变更  

### 🏷️ 标签分类

- `feat`: 新功能开发 (15个提交)
- `refactor`: 代码重构 (8个提交) 
- `fix`: Bug修复 (3个提交)
- `docs`: 文档更新 (1个提交)
- `chore`: 构建工具和配置 (1个提交)

### 💡 开发建议

1. **代码审查**: 建议对假人系统进行全面测试
2. **性能监控**: 关注守卫系统优化后的性能表现  
3. **文档更新**: 及时更新API文档和用户手册
4. **备份策略**: 重要数据文件建议多重备份

---

*本次更新大幅提升了系统的可维护性、功能完整性和开发效率，为后续功能开发奠定了坚实基础。*